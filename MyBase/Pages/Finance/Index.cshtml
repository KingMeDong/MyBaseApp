@page
@model MyBase.Pages.Finance.IndexModel
@{
    ViewData["Title"] = "Finance";
}

<div class="container finance-page" style="max-width:1200px; margin:auto">

  <!-- Steuerung: Gateway / Realtime -->
  <div class="grid" style="display:grid; grid-template-columns: 1fr 1fr; gap:16px;">

    <!-- Gateway -->
    <div class="card">
      <div class="card-header">Gateway</div>
      <div class="card-body">
        <div class="btn-group" role="group">
          <button class="btn btn-success" onclick="startGateway()">Start</button>
          <button class="btn btn-danger"  onclick="stopGateway()">Stop</button>
        </div>
      </div>
    </div>

    <!-- Realtime-Feed -->
    <div class="card">
      <div class="card-header">Realtime-Feed</div>
      <div class="card-body">
        <div class="btn-group" role="group">
          <button class="btn btn-success" onclick="startFeed()">Start</button>
          <button class="btn btn-danger"  onclick="stopFeed()">Stop</button>
        </div>
      </div>
    </div>

    <!-- Backfill -->
    <div class="card">
      <div class="card-header">Backfill & Tools</div>
      <div class="card-body">
        <div class="backfill-dates">
            <div class="backfill-date-group">
                <label>Start</label>
                <input type="date" id="bfStart" />
            </div>
            <div class="backfill-date-group">
                <label>Ende</label>
                <input type="date" id="bfEnd" />
            </div>
        </div>
        
        <div style="margin-bottom: 12px;">
             <label class="form-check" style="cursor:pointer; display:flex; align-items:center;">
              <input id="rthOnly" type="checkbox" class="form-check-input" checked />
              <span class="form-check-label">RTH-only</span>
            </label>
        </div>

        <div class="backfill-actions">
          <button class="btn btn-success" onclick="startBackfill()">Start Backfill</button>
          <button class="btn btn-secondary" onclick="checkGaps()">Tabelle auf Lücken prüfen</button>
        </div>
      </div>
    </div>

    <!-- Status -->
    <div class="card">
      <div class="card-header">Status</div>
      <div class="card-body">
<pre class="mb-0" style="white-space:pre-line">
Gateway Desired: <span id="gw-desired">-</span>
Session:         <span id="gw-session">-</span>

Feed Desired:    <span id="md-desired">-</span>
Feed:            <span id="md-feed">-</span>
Heartbeat:       <span id="md-heartbeat">-</span>
Realtime:        <span id="md-realtime">-</span>
Error:           <span id="md-error">-</span>
</pre>
      </div>
    </div>
  </div>

  <!-- Rolling-Log -->
  <div class="card mt-3">
    <div class="card-header d-flex align-items-center justify-content-between">
      <span>Rolling Log</span>
      <div>
        <button class="btn btn-success btn-sm" onclick="refreshLog()">Refresh</button>
        <label class="ms-2">
          <input type="checkbox" id="autoRefresh" checked /> Auto
        </label>
      </div>
    </div>
    <div class="card-body" style="padding:0">
      <pre id="logArea" style="margin:0; height:380px; overflow:auto; background:#0f0f13; color:#e7e7e7; padding:12px;"></pre>
    </div>
  </div>

</div>

<script>
// ---------- Helpers ----------
function setText(sel, v) {
  const el = document.querySelector(sel);
  if (el) el.textContent = v ?? '-';
}
function fmtDt(v) {
  if (!v) return '-';
  try {
    const d = new Date(v);
    if (isNaN(d)) return v;
    return d.toLocaleString();
  } catch { return v; }
}

// ---------- Status ----------
async function refreshStatus() {
  try {
    const r = await fetch('/api/marketdata/status', { cache: 'no-store' });
    if (!r.ok) throw new Error('status ' + r.status);
    const s = await r.json();

    // Gateway
    setText('#gw-desired', s.gatewayDesired ?? '-');
    setText('#gw-session', s.session ?? '-');

    // Realtime-Feed
    setText('#md-desired', (s.feedDesired ?? s.desired) ?? '-');
    setText('#md-feed',    s.feed ?? '-');

    // Zeitstempel
    setText('#md-heartbeat', fmtDt(s.heartbeat));
    setText('#md-realtime',  fmtDt(s.realtime));
    setText('#md-error',     s.error ?? '-');
  } catch (e) {
    console.error(e);
  }
}




// ---------- Log ----------
async function refreshLog() {
  try {
    const r = await fetch('/api/marketdata/log', { cache: 'no-store' });
    if (!r.ok) return;
    const t = await r.text();
    const area = document.querySelector('#logArea');
    area.textContent = t;
    area.scrollTop = area.scrollHeight;
  } catch (e) { console.error(e); }
}

// ---------- Aktionen ----------
async function startGateway() {
  await fetch('/api/gateway/start', { method:'POST' });
  await refreshStatus();
}
async function stopGateway() {
  await fetch('/api/gateway/stop', { method:'POST' });
  await refreshStatus();
}
async function startFeed() {
  await fetch('/api/marketdata/start', { method:'POST' });
  await refreshStatus();
}
async function stopFeed() {
  await fetch('/api/marketdata/stop', { method:'POST' });
  await refreshStatus();
}
async function startBackfill() {
  const rth = document.querySelector('#rthOnly').checked;
  const startVal = document.querySelector('#bfStart').value;
  const endVal = document.querySelector('#bfEnd').value;

  const body = { RthOnly: rth };
  
  if (startVal) body.StartUtc = new Date(startVal).toISOString();
  if (endVal)   body.EndUtc   = new Date(endVal).toISOString();

  await fetch('/api/backfill/start', {
    method:'POST',
    headers:{ 'Content-Type':'application/json' },
    body: JSON.stringify(body)
  });
}

function checkGaps() {
    alert("Funktion 'Bars auf Lücken prüfen' ist noch nicht implementiert.");
}

// ---------- Auto-Refresh ----------
let timer = null;
function setupAuto() {
  const auto = document.querySelector('#autoRefresh');
  const start = () => {
    if (timer) clearInterval(timer);
    timer = setInterval(async () => {
      await refreshStatus();
      await refreshLog();
    }, 1000);
  };
  const stop = () => { if (timer) { clearInterval(timer); timer = null; } };

  auto.addEventListener('change', () => auto.checked ? start() : stop());
  if (auto.checked) start();
}

document.addEventListener('DOMContentLoaded', async () => {
  // Defaults setzen
  const now = new Date();
  const weekAgo = new Date();
  weekAgo.setDate(now.getDate() - 7);
  
  document.getElementById('bfEnd').valueAsDate = now;
  document.getElementById('bfStart').valueAsDate = weekAgo;

  await refreshStatus();
  await refreshLog();
  setupAuto();
});
</script>


    <style >
    :root {
        --bg: #0d0f14;
        --card: #141823;
        --border: #23293a;
        --text: #e7e7e7;
        --muted: #b9c0ce;
        --ok: #2f9e63;
        --err: #d34a4a;
        --radius: 10px;
    }

    .container.finance-page {
        max-width: 1200px;
        margin: auto;
        padding: 8px 10px 22px;
    }

    .grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
    }

    .card {
        background: var(--card);
        color: var(--text);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        box-shadow: 0 1px 0 rgba(255,255,255,0.02),0 8px 24px rgba(0,0,0,0.22);
    }

    .card-header {
        font-weight: 600;
        padding: 10px 14px;
        border-bottom: 1px solid var(--border);
        letter-spacing: .2px;
    }

    .card-body {
        padding: 14px;
    }

    .btn {
        padding: 6px 11px;
        border-radius: 8px;
        line-height: 1;
        border: 0;
        cursor: pointer
    }

        .btn:focus {
            outline: none
        }

    .btn-success {
        background: var(--ok)
    }

        .btn-success:focus {
            box-shadow: 0 0 0 2px rgba(47,158,99,.25)
        }

    .btn-danger {
        background: var(--err)
    }

        .btn-danger:focus {
            box-shadow: 0 0 0 2px rgba(211,74,74,.25)
        }

    .btn-sm {
        padding: 4px 10px;
        font-size: .9rem
    }

    .form-check-input {
        margin-right: 6px;
        transform: translateY(1px)
    }

    .card .card-body pre {
        margin: 0;
        padding: 2px 0;
        background: transparent;
        font-family: ui-monospace,SFMono-Regular,Menlo,Consolas,"Liberation Mono",monospace;
        font-size: .95rem;
        line-height: 1.25rem;
        color: var(--muted);
        white-space: pre; /* (kein zusätzliches Zeilenhöhen-Spacing) */
        font-variant-numeric: tabular-nums; /* (gleich breite Ziffern für saubere Spalten) */
    }

    #logArea {
        margin: 0;
        height: 380px;
        overflow: auto;
        background: #0f0f13;
        color: var(--text);
        padding: 12px;
        font-family: ui-monospace,SFMono-Regular,Menlo,Consolas,"Liberation Mono",monospace;
        font-size: .95rem;
        line-height: 1.25rem;
    }

    /* Backfill Custom Styles */
    .backfill-dates {
        display: flex;
        gap: 10px;
        margin-bottom: 12px;
    }
    .backfill-date-group {
        flex: 1;
        display: flex;
        flex-direction: column;
    }
    .backfill-date-group label {
        font-size: 0.85rem;
        color: var(--muted);
        margin-bottom: 4px;
        display: block;
    }
    .backfill-date-group input {
        width: 100%;
        background: #23293a;
        color: #fff;
        border: 1px solid #343a40;
        padding: 6px 8px;
        border-radius: 6px;
        font-size: 0.9rem;
        box-sizing: border-box; /* Prevents overflow */
    }
    .backfill-actions {
        display: flex;
        flex-direction: column;
        gap: 8px;
        margin-top: 16px;
    }
    .backfill-actions button {
        width: 100%;
        text-align: center;
        padding: 8px;
    }
    .btn-secondary {
        background: #343a40;
        color: #ccc;
    }
    .btn-secondary:hover {
        background: #414850;
        color: #fff;
    }
</style>

